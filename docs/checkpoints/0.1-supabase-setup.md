# Checkpoint 0.1: Supabase Setup

**Date Started:** 2025-11-19
**Status:** üîÑ In Progress
**Estimated Time:** 1 hour

## Objective
Set up Supabase project with database schema, storage buckets, and authentication configured.

## Progress Log

### 2025-11-19 - Setup Instructions Created
- Created database schema SQL file
- Prepared setup instructions
- Ready for user to create Supabase project

## Setup Instructions

### Step 1: Create Supabase Account (5 minutes)

1. Go to [https://supabase.com](https://supabase.com)
2. Click "Start your project"
3. Sign up with GitHub (recommended) or email
4. Verify email if needed

### Step 2: Create New Project (5 minutes)

1. Click "New Project"
2. Fill in details:
   - **Name:** ocean-ml
   - **Database Password:** [Generate strong password - SAVE THIS!]
   - **Region:** Choose closest to you
   - **Plan:** Free tier is fine for now
3. Click "Create new project"
4. Wait 2-3 minutes for project to initialize

### Step 3: Run Database Schema (10 minutes)

1. In Supabase dashboard, go to **SQL Editor** (left sidebar)
2. Click "New Query"
3. Copy entire contents of `docs/database-schema.sql`
4. Paste into SQL editor
5. Click "Run" (or press Ctrl+Enter)
6. Verify success message appears
7. Go to **Table Editor** - you should see: videos, annotations, training_runs, inference_runs, activity_log

### Step 4: Create Storage Buckets (10 minutes)

1. Go to **Storage** in left sidebar
2. Click "Create a new bucket"

**Bucket 1: videos**
- Name: `videos`
- Public: No (keep private)
- File size limit: 100 MB
- Allowed MIME types: `video/*`
- Click "Create bucket"

**Bucket 2: annotations**
- Name: `annotations`
- Public: No
- File size limit: 10 MB
- Allowed MIME types: `text/plain`
- Click "Create bucket"

**Bucket 3: models**
- Name: `models`
- Public: No
- File size limit: 500 MB
- Allowed MIME types: `application/octet-stream`
- Click "Create bucket"

**Bucket 4: inference**
- Name: `inference`
- Public: No
- File size limit: 100 MB
- Allowed MIME types: `application/json,video/*`
- Click "Create bucket"

### Step 5: Configure Storage Policies (15 minutes)

For each bucket, set up access policies:

1. Click on bucket name
2. Go to "Policies" tab
3. Click "New Policy"

**For `videos` bucket:**

Policy 1: Allow authenticated users to upload
```sql
CREATE POLICY "Allow authenticated uploads"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'videos');
```

Policy 2: Allow authenticated users to read
```sql
CREATE POLICY "Allow authenticated reads"
ON storage.objects FOR SELECT
TO authenticated
USING (bucket_id = 'videos');
```

Policy 3: Allow users to delete their own files
```sql
CREATE POLICY "Allow users to delete own files"
ON storage.objects FOR DELETE
TO authenticated
USING (bucket_id = 'videos' AND owner = auth.uid());
```

**Repeat similar policies for other buckets** (annotations, models, inference)

### Step 6: Enable Authentication (5 minutes)

1. Go to **Authentication** ‚Üí **Providers**
2. Enable **Email** provider (already enabled by default)
3. Enable **Google** provider:
   - Click on Google
   - Toggle "Enable Sign in with Google"
   - For now, use Supabase's OAuth credentials (for testing)
   - Later, you can add your own Google OAuth credentials
4. Save changes

### Step 7: Get API Credentials (5 minutes)

1. Go to **Settings** ‚Üí **API**
2. Note down these values:

```
Project URL: https://xxxxx.supabase.co
anon public key: eyJhbGc...
service_role key: eyJhbGc... (keep secret!)
```

3. Create `.env` file in `backend/` directory:

```bash
cd Ocean-ML/backend
cp .env.example .env
```

4. Edit `backend/.env` and add your credentials:

```
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_KEY=your-anon-key
SUPABASE_SERVICE_KEY=your-service-role-key
```

### Step 8: Test Connection (10 minutes)

Create a test script:

```python
# backend/test_supabase_connection.py
from supabase import create_client
import os
from dotenv import load_dotenv

load_dotenv()

def test_connection():
    """Test Supabase connection"""
    try:
        supabase = create_client(
            os.getenv("SUPABASE_URL"),
            os.getenv("SUPABASE_KEY")
        )

        # Test: List tables (should work even with empty tables)
        print("‚úÖ Connected to Supabase!")

        # Test: Insert and read from videos table
        test_video = {
            "filename": "test.mp4",
            "storage_path": "videos/test.mp4",
            "file_size_bytes": 1000
        }

        # This will fail with RLS if not authenticated, which is expected
        result = supabase.table('videos').insert(test_video).execute()

        if result.data:
            print("‚úÖ Can write to videos table")

            # Clean up
            supabase.table('videos').delete().eq('filename', 'test.mp4').execute()
            print("‚úÖ Can delete from videos table")
        else:
            print("‚ö†Ô∏è RLS working (cannot write without auth - this is good!)")

        # Test storage
        buckets = supabase.storage.list_buckets()
        print(f"‚úÖ Storage buckets: {[b['name'] for b in buckets]}")

        print("\nüéâ Supabase setup complete!")

    except Exception as e:
        print(f"‚ùå Error: {e}")
        return False

    return True

if __name__ == "__main__":
    test_connection()
```

Run the test:
```bash
cd backend
pip install supabase python-dotenv
python test_supabase_connection.py
```

## Testing Checklist

- [ ] Supabase project created
- [ ] Database schema applied successfully
- [ ] All 5 tables visible in Table Editor
- [ ] All 4 storage buckets created
- [ ] Storage policies configured
- [ ] Authentication providers enabled
- [ ] API credentials saved in .env
- [ ] Connection test script runs successfully
- [ ] Can see buckets in storage
- [ ] RLS preventing unauthorized access

## Issues Encountered

### Issue: SQL script fails
**Solution:** Make sure you're running it in SQL Editor, not Table Editor. Check for syntax errors.

### Issue: Cannot create storage buckets
**Solution:** Make sure project is fully initialized (wait a few minutes after creation).

### Issue: Test script cannot connect
**Solution:**
- Check .env file has correct URL and keys
- Make sure no extra spaces in keys
- Verify SUPABASE_URL includes https://

## Learnings
- Supabase takes 2-3 minutes to initialize new projects
- RLS is enabled by default and blocks unauthorized access (good!)
- Storage buckets need explicit policies for access
- anon key is safe for frontend, service_role key should only be in backend

## Next Steps
- [ ] Complete checkpoint documentation
- [ ] Move to Checkpoint 0.2 (Modal setup)
- [ ] Create backend structure

## Time Spent
- Setup time: ~1 hour (includes account creation, configuration, testing)

---

**Once you complete these steps, reply with "Supabase setup complete" and I'll verify everything is working before moving to the next checkpoint.**
